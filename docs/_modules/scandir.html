


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>scandir &#8212; effluxpy 0.5.6 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/logo.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for scandir</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;scandir, a better directory iterator and faster os.walk(), now in the Python 3.5 stdlib</span>

<span class="sd">scandir() is a generator version of os.listdir() that returns an</span>
<span class="sd">iterator over files in a directory, and also exposes the extra</span>
<span class="sd">information most OSes provide while iterating files in a directory</span>
<span class="sd">(such as type and stat information).</span>

<span class="sd">This module also includes a version of os.walk() that uses scandir()</span>
<span class="sd">to speed it up significantly.</span>

<span class="sd">See README.md or https://github.com/benhoyt/scandir for rationale and</span>
<span class="sd">docs, or read PEP 471 (https://www.python.org/dev/peps/pep-0471/) for</span>
<span class="sd">more details on its inclusion into Python 3.5</span>

<span class="sd">scandir is released under the new BSD 3-clause license. See</span>
<span class="sd">LICENSE.txt for the full license text.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>

<span class="kn">from</span> <span class="nn">errno</span> <span class="k">import</span> <span class="n">ENOENT</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">listdir</span><span class="p">,</span> <span class="n">lstat</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">strerror</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">islink</span>
<span class="kn">from</span> <span class="nn">stat</span> <span class="k">import</span> <span class="n">S_IFDIR</span><span class="p">,</span> <span class="n">S_IFLNK</span><span class="p">,</span> <span class="n">S_IFREG</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">_scandir</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_scandir</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ctypes</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">ctypes</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">if</span> <span class="n">_scandir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ctypes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">warnings</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;scandir can&#39;t find the compiled _scandir C module &quot;</span>
                  <span class="s2">&quot;or ctypes, using slow generic fallback&quot;</span><span class="p">)</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;1.6&#39;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scandir&#39;</span><span class="p">,</span> <span class="s1">&#39;walk&#39;</span><span class="p">]</span>

<span class="c1"># Windows FILE_ATTRIBUTE constants for interpreting the</span>
<span class="c1"># FIND_DATA.dwFileAttributes member</span>
<span class="n">FILE_ATTRIBUTE_ARCHIVE</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">FILE_ATTRIBUTE_COMPRESSED</span> <span class="o">=</span> <span class="mi">2048</span>
<span class="n">FILE_ATTRIBUTE_DEVICE</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">FILE_ATTRIBUTE_DIRECTORY</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">FILE_ATTRIBUTE_ENCRYPTED</span> <span class="o">=</span> <span class="mi">16384</span>
<span class="n">FILE_ATTRIBUTE_HIDDEN</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">FILE_ATTRIBUTE_INTEGRITY_STREAM</span> <span class="o">=</span> <span class="mi">32768</span>
<span class="n">FILE_ATTRIBUTE_NORMAL</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">FILE_ATTRIBUTE_NOT_CONTENT_INDEXED</span> <span class="o">=</span> <span class="mi">8192</span>
<span class="n">FILE_ATTRIBUTE_NO_SCRUB_DATA</span> <span class="o">=</span> <span class="mi">131072</span>
<span class="n">FILE_ATTRIBUTE_OFFLINE</span> <span class="o">=</span> <span class="mi">4096</span>
<span class="n">FILE_ATTRIBUTE_READONLY</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">FILE_ATTRIBUTE_REPARSE_POINT</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">FILE_ATTRIBUTE_SPARSE_FILE</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">FILE_ATTRIBUTE_SYSTEM</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">FILE_ATTRIBUTE_TEMPORARY</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">FILE_ATTRIBUTE_VIRTUAL</span> <span class="o">=</span> <span class="mi">65536</span>

<span class="n">IS_PY3</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">if</span> <span class="n">IS_PY3</span><span class="p">:</span>
    <span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span>  <span class="c1"># Because Python &lt;= 3.2 doesn&#39;t have u&#39;unicode&#39; syntax</span>


<span class="k">class</span> <span class="nc">GenericDirEntry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;_stat&#39;</span><span class="p">,</span> <span class="s1">&#39;_lstat&#39;</span><span class="p">,</span> <span class="s1">&#39;_scandir_path&#39;</span><span class="p">,</span> <span class="s1">&#39;_path&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scandir_path</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scandir_path</span> <span class="o">=</span> <span class="n">scandir_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scandir_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span>

    <span class="k">def</span> <span class="nf">stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">follow_symlinks</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span> <span class="o">=</span> <span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span> <span class="o">=</span> <span class="n">lstat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span>

    <span class="k">def</span> <span class="nf">is_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Path doesn&#39;t exist or is a broken symlink</span>
        <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">0o170000</span> <span class="o">==</span> <span class="n">S_IFDIR</span>

    <span class="k">def</span> <span class="nf">is_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Path doesn&#39;t exist or is a broken symlink</span>
        <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">0o170000</span> <span class="o">==</span> <span class="n">S_IFREG</span>

    <span class="k">def</span> <span class="nf">is_symlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Path doesn&#39;t exist or is a broken symlink</span>
        <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">0o170000</span> <span class="o">==</span> <span class="n">S_IFLNK</span>

    <span class="k">def</span> <span class="nf">inode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">st_ino</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1!r}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="fm">__repr__</span> <span class="o">=</span> <span class="fm">__str__</span>


<span class="k">def</span> <span class="nf">_scandir_generic</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">unicode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Like os.listdir(), but yield DirEntry objects instead of returning</span>
<span class="sd">    a list of names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">GenericDirEntry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">if</span> <span class="n">IS_PY3</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">scandir_generic</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">unicode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;os.scandir() doesn&#39;t support bytes path on Windows, use Unicode instead&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_scandir_generic</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">scandir_generic</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_scandir_generic</span><span class="o">.</span><span class="vm">__doc__</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">scandir_generic</span> <span class="o">=</span> <span class="n">_scandir_generic</span>


<span class="n">scandir_c</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">scandir_python</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ctypes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ctypes</span> <span class="k">import</span> <span class="n">wintypes</span>

        <span class="c1"># Various constants from windows.h</span>
        <span class="n">INVALID_HANDLE_VALUE</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ERROR_FILE_NOT_FOUND</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">ERROR_NO_MORE_FILES</span> <span class="o">=</span> <span class="mi">18</span>
        <span class="n">IO_REPARSE_TAG_SYMLINK</span> <span class="o">=</span> <span class="mh">0xA000000C</span>

        <span class="c1"># Numer of seconds between 1601-01-01 and 1970-01-01</span>
        <span class="n">SECONDS_BETWEEN_EPOCHS</span> <span class="o">=</span> <span class="mi">11644473600</span>

        <span class="n">kernel32</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span>

        <span class="c1"># ctypes wrappers for (wide string versions of) FindFirstFile,</span>
        <span class="c1"># FindNextFile, and FindClose</span>
        <span class="n">FindFirstFile</span> <span class="o">=</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">FindFirstFileW</span>
        <span class="n">FindFirstFile</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">wintypes</span><span class="o">.</span><span class="n">LPCWSTR</span><span class="p">,</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">wintypes</span><span class="o">.</span><span class="n">WIN32_FIND_DATAW</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">FindFirstFile</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">wintypes</span><span class="o">.</span><span class="n">HANDLE</span>

        <span class="n">FindNextFile</span> <span class="o">=</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">FindNextFileW</span>
        <span class="n">FindNextFile</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">wintypes</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">,</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">wintypes</span><span class="o">.</span><span class="n">WIN32_FIND_DATAW</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">FindNextFile</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">wintypes</span><span class="o">.</span><span class="n">BOOL</span>

        <span class="n">FindClose</span> <span class="o">=</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">FindClose</span>
        <span class="n">FindClose</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">wintypes</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">]</span>
        <span class="n">FindClose</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">wintypes</span><span class="o">.</span><span class="n">BOOL</span>

        <span class="n">Win32StatResult</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Win32StatResult&#39;</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">&#39;st_mode&#39;</span><span class="p">,</span>
            <span class="s1">&#39;st_ino&#39;</span><span class="p">,</span>
            <span class="s1">&#39;st_dev&#39;</span><span class="p">,</span>
            <span class="s1">&#39;st_nlink&#39;</span><span class="p">,</span>
            <span class="s1">&#39;st_uid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;st_gid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;st_size&#39;</span><span class="p">,</span>
            <span class="s1">&#39;st_atime&#39;</span><span class="p">,</span>
            <span class="s1">&#39;st_mtime&#39;</span><span class="p">,</span>
            <span class="s1">&#39;st_ctime&#39;</span><span class="p">,</span>
            <span class="s1">&#39;st_atime_ns&#39;</span><span class="p">,</span>
            <span class="s1">&#39;st_mtime_ns&#39;</span><span class="p">,</span>
            <span class="s1">&#39;st_ctime_ns&#39;</span><span class="p">,</span>
            <span class="s1">&#39;st_file_attributes&#39;</span><span class="p">,</span>
        <span class="p">])</span>

        <span class="k">def</span> <span class="nf">filetime_to_time</span><span class="p">(</span><span class="n">filetime</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Convert Win32 FILETIME to time since Unix epoch in seconds.&quot;&quot;&quot;</span>
            <span class="n">total</span> <span class="o">=</span> <span class="n">filetime</span><span class="o">.</span><span class="n">dwHighDateTime</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="n">filetime</span><span class="o">.</span><span class="n">dwLowDateTime</span>
            <span class="k">return</span> <span class="n">total</span> <span class="o">/</span> <span class="mi">10000000</span> <span class="o">-</span> <span class="n">SECONDS_BETWEEN_EPOCHS</span>

        <span class="k">def</span> <span class="nf">find_data_to_stat</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Convert Win32 FIND_DATA struct to stat_result.&quot;&quot;&quot;</span>
            <span class="c1"># First convert Win32 dwFileAttributes to st_mode</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dwFileAttributes</span>
            <span class="n">st_mode</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">attributes</span> <span class="o">&amp;</span> <span class="n">FILE_ATTRIBUTE_DIRECTORY</span><span class="p">:</span>
                <span class="n">st_mode</span> <span class="o">|=</span> <span class="n">S_IFDIR</span> <span class="o">|</span> <span class="mo">0o111</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st_mode</span> <span class="o">|=</span> <span class="n">S_IFREG</span>
            <span class="k">if</span> <span class="n">attributes</span> <span class="o">&amp;</span> <span class="n">FILE_ATTRIBUTE_READONLY</span><span class="p">:</span>
                <span class="n">st_mode</span> <span class="o">|=</span> <span class="mo">0o444</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st_mode</span> <span class="o">|=</span> <span class="mo">0o666</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">attributes</span> <span class="o">&amp;</span> <span class="n">FILE_ATTRIBUTE_REPARSE_POINT</span> <span class="ow">and</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">dwReserved0</span> <span class="o">==</span> <span class="n">IO_REPARSE_TAG_SYMLINK</span><span class="p">):</span>
                <span class="n">st_mode</span> <span class="o">^=</span> <span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">0o170000</span>
                <span class="n">st_mode</span> <span class="o">|=</span> <span class="n">S_IFLNK</span>

            <span class="n">st_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">nFileSizeHigh</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="n">data</span><span class="o">.</span><span class="n">nFileSizeLow</span>
            <span class="n">st_atime</span> <span class="o">=</span> <span class="n">filetime_to_time</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ftLastAccessTime</span><span class="p">)</span>
            <span class="n">st_mtime</span> <span class="o">=</span> <span class="n">filetime_to_time</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ftLastWriteTime</span><span class="p">)</span>
            <span class="n">st_ctime</span> <span class="o">=</span> <span class="n">filetime_to_time</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ftCreationTime</span><span class="p">)</span>

            <span class="c1"># Some fields set to zero per CPython&#39;s posixmodule.c: st_ino, st_dev,</span>
            <span class="c1"># st_nlink, st_uid, st_gid</span>
            <span class="k">return</span> <span class="n">Win32StatResult</span><span class="p">(</span><span class="n">st_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">st_size</span><span class="p">,</span>
                                   <span class="n">st_atime</span><span class="p">,</span> <span class="n">st_mtime</span><span class="p">,</span> <span class="n">st_ctime</span><span class="p">,</span>
                                   <span class="nb">int</span><span class="p">(</span><span class="n">st_atime</span> <span class="o">*</span> <span class="mi">1000000000</span><span class="p">),</span>
                                   <span class="nb">int</span><span class="p">(</span><span class="n">st_mtime</span> <span class="o">*</span> <span class="mi">1000000000</span><span class="p">),</span>
                                   <span class="nb">int</span><span class="p">(</span><span class="n">st_ctime</span> <span class="o">*</span> <span class="mi">1000000000</span><span class="p">),</span>
                                   <span class="n">attributes</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">Win32DirEntryPython</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;_stat&#39;</span><span class="p">,</span> <span class="s1">&#39;_lstat&#39;</span><span class="p">,</span> <span class="s1">&#39;_find_data&#39;</span><span class="p">,</span> <span class="s1">&#39;_scandir_path&#39;</span><span class="p">,</span> <span class="s1">&#39;_path&#39;</span><span class="p">,</span> <span class="s1">&#39;_inode&#39;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scandir_path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">find_data</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scandir_path</span> <span class="o">=</span> <span class="n">scandir_path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_find_data</span> <span class="o">=</span> <span class="n">find_data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_inode</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scandir_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span>

            <span class="k">def</span> <span class="nf">stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">follow_symlinks</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">():</span>
                            <span class="c1"># It&#39;s a symlink, call link-following stat()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span> <span class="o">=</span> <span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Not a symlink, stat is same as lstat value</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span> <span class="o">=</span> <span class="n">find_data_to_stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_data</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Lazily convert to stat object, because it&#39;s slow</span>
                        <span class="c1"># in Python, and often we only need is_dir() etc</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span> <span class="o">=</span> <span class="n">find_data_to_stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_data</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span>

            <span class="k">def</span> <span class="nf">is_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">is_symlink</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">follow_symlinks</span> <span class="ow">and</span> <span class="n">is_symlink</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">0o170000</span> <span class="o">==</span> <span class="n">S_IFDIR</span>
                    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">:</span>
                            <span class="k">raise</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">is_symlink</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_data</span><span class="o">.</span><span class="n">dwFileAttributes</span> <span class="o">&amp;</span>
                            <span class="n">FILE_ATTRIBUTE_DIRECTORY</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">is_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">is_symlink</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">follow_symlinks</span> <span class="ow">and</span> <span class="n">is_symlink</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">0o170000</span> <span class="o">==</span> <span class="n">S_IFREG</span>
                    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">:</span>
                            <span class="k">raise</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">is_symlink</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_data</span><span class="o">.</span><span class="n">dwFileAttributes</span> <span class="o">&amp;</span>
                            <span class="n">FILE_ATTRIBUTE_DIRECTORY</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">is_symlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_data</span><span class="o">.</span><span class="n">dwFileAttributes</span> <span class="o">&amp;</span>
                            <span class="n">FILE_ATTRIBUTE_REPARSE_POINT</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_find_data</span><span class="o">.</span><span class="n">dwReserved0</span> <span class="o">==</span> <span class="n">IO_REPARSE_TAG_SYMLINK</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">inode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_inode</span> <span class="o">=</span> <span class="n">lstat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_ino</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inode</span>

            <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1!r}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="fm">__repr__</span> <span class="o">=</span> <span class="fm">__str__</span>

        <span class="k">def</span> <span class="nf">win_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="ne">WindowsError</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">FormatError</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="n">exc</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="k">return</span> <span class="n">exc</span>

        <span class="k">def</span> <span class="nf">_scandir_python</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">unicode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)):</span>
            <span class="sd">&quot;&quot;&quot;Like os.listdir(), but yield DirEntry objects instead of returning</span>
<span class="sd">            a list of names.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Call FindFirstFile and handle errors</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">is_bytes</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;mbcs&#39;</span><span class="p">,</span> <span class="s1">&#39;strict&#39;</span><span class="p">),</span> <span class="s1">&#39;*.*&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_bytes</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;*.*&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">wintypes</span><span class="o">.</span><span class="n">WIN32_FIND_DATAW</span><span class="p">()</span>
            <span class="n">data_p</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">FindFirstFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data_p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handle</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">GetLastError</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">error</span> <span class="o">==</span> <span class="n">ERROR_FILE_NOT_FOUND</span><span class="p">:</span>
                    <span class="c1"># No files, don&#39;t yield anything</span>
                    <span class="k">return</span>
                <span class="k">raise</span> <span class="n">win_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

            <span class="c1"># Call FindNextFile in a loop, stopping when no more files</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># Skip &#39;.&#39; and &#39;..&#39; (current and parent directory), but</span>
                    <span class="c1"># otherwise yield (filename, stat_result) tuple</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cFileName</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">is_bytes</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;mbcs&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">Win32DirEntryPython</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                    <span class="n">data</span> <span class="o">=</span> <span class="n">wintypes</span><span class="o">.</span><span class="n">WIN32_FIND_DATAW</span><span class="p">()</span>
                    <span class="n">data_p</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="n">FindNextFile</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">data_p</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">GetLastError</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">error</span> <span class="o">==</span> <span class="n">ERROR_NO_MORE_FILES</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">raise</span> <span class="n">win_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">FindClose</span><span class="p">(</span><span class="n">handle</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">win_error</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">GetLastError</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">IS_PY3</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">scandir_python</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">unicode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;os.scandir() doesn&#39;t support bytes path on Windows, use Unicode instead&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">_scandir_python</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">scandir_python</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_scandir_python</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scandir_python</span> <span class="o">=</span> <span class="n">_scandir_python</span>

    <span class="k">if</span> <span class="n">_scandir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scandir_c</span> <span class="o">=</span> <span class="n">_scandir</span><span class="o">.</span><span class="n">scandir</span>

    <span class="k">if</span> <span class="n">_scandir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scandir</span> <span class="o">=</span> <span class="n">scandir_c</span>
    <span class="k">elif</span> <span class="n">ctypes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scandir</span> <span class="o">=</span> <span class="n">scandir_python</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scandir</span> <span class="o">=</span> <span class="n">scandir_generic</span>


<span class="c1"># Linux, OS X, and BSD implementation</span>
<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="s1">&#39;darwin&#39;</span><span class="p">,</span> <span class="s1">&#39;sunos5&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="s1">&#39;bsd&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">:</span>
    <span class="n">have_dirent_d_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;sunos5&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ctypes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">have_dirent_d_type</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ctypes.util</span>

        <span class="n">DIR_p</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span>

        <span class="c1"># Rather annoying how the dirent struct is slightly different on each</span>
        <span class="c1"># platform. The only fields we care about are d_name and d_type.</span>
        <span class="k">class</span> <span class="nc">Dirent</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;linux&#39;</span><span class="p">):</span>
                <span class="n">_fields_</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;d_ino&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulong</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;d_off&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_long</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;d_reclen&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ushort</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;d_type&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_byte</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;d_name&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span> <span class="o">*</span> <span class="mi">256</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_fields_</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;d_ino&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint32</span><span class="p">),</span>  <span class="c1"># must be uint32, not ulong</span>
                    <span class="p">(</span><span class="s1">&#39;d_reclen&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ushort</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;d_type&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_byte</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;d_namlen&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_byte</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;d_name&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span> <span class="o">*</span> <span class="mi">256</span><span class="p">),</span>
                <span class="p">)</span>

        <span class="n">DT_UNKNOWN</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">DT_DIR</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">DT_REG</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">DT_LNK</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="n">Dirent_p</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">Dirent</span><span class="p">)</span>
        <span class="n">Dirent_pp</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">Dirent_p</span><span class="p">)</span>

        <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_library</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="n">use_errno</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">opendir</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">opendir</span>
        <span class="n">opendir</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span><span class="p">]</span>
        <span class="n">opendir</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">DIR_p</span>

        <span class="n">readdir_r</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">readdir_r</span>
        <span class="n">readdir_r</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">DIR_p</span><span class="p">,</span> <span class="n">Dirent_p</span><span class="p">,</span> <span class="n">Dirent_pp</span><span class="p">]</span>
        <span class="n">readdir_r</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>

        <span class="n">closedir</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">closedir</span>
        <span class="n">closedir</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">DIR_p</span><span class="p">]</span>
        <span class="n">closedir</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>

        <span class="n">file_system_encoding</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()</span>

        <span class="k">class</span> <span class="nc">PosixDirEntry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;_d_type&#39;</span><span class="p">,</span> <span class="s1">&#39;_stat&#39;</span><span class="p">,</span> <span class="s1">&#39;_lstat&#39;</span><span class="p">,</span> <span class="s1">&#39;_scandir_path&#39;</span><span class="p">,</span> <span class="s1">&#39;_path&#39;</span><span class="p">,</span> <span class="s1">&#39;_inode&#39;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scandir_path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">d_type</span><span class="p">,</span> <span class="n">inode</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scandir_path</span> <span class="o">=</span> <span class="n">scandir_path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_d_type</span> <span class="o">=</span> <span class="n">d_type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_inode</span> <span class="o">=</span> <span class="n">inode</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scandir_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span>

            <span class="k">def</span> <span class="nf">stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">follow_symlinks</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span> <span class="o">=</span> <span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span> <span class="o">=</span> <span class="n">lstat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span> <span class="o">=</span> <span class="n">lstat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lstat</span>

            <span class="k">def</span> <span class="nf">is_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d_type</span> <span class="o">==</span> <span class="n">DT_UNKNOWN</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="n">follow_symlinks</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">())):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">:</span>
                            <span class="k">raise</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">0o170000</span> <span class="o">==</span> <span class="n">S_IFDIR</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_type</span> <span class="o">==</span> <span class="n">DT_DIR</span>

            <span class="k">def</span> <span class="nf">is_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d_type</span> <span class="o">==</span> <span class="n">DT_UNKNOWN</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="n">follow_symlinks</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">())):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">:</span>
                            <span class="k">raise</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">0o170000</span> <span class="o">==</span> <span class="n">S_IFREG</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_type</span> <span class="o">==</span> <span class="n">DT_REG</span>

            <span class="k">def</span> <span class="nf">is_symlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_type</span> <span class="o">==</span> <span class="n">DT_UNKNOWN</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">:</span>
                            <span class="k">raise</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">0o170000</span> <span class="o">==</span> <span class="n">S_IFLNK</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_type</span> <span class="o">==</span> <span class="n">DT_LNK</span>

            <span class="k">def</span> <span class="nf">inode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inode</span>

            <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1!r}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="fm">__repr__</span> <span class="o">=</span> <span class="fm">__str__</span>

        <span class="k">def</span> <span class="nf">posix_error</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">errno</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">get_errno</span><span class="p">()</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">))</span>
            <span class="n">exc</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="k">return</span> <span class="n">exc</span>

        <span class="k">def</span> <span class="nf">scandir_python</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">unicode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)):</span>
            <span class="sd">&quot;&quot;&quot;Like os.listdir(), but yield DirEntry objects instead of returning</span>
<span class="sd">            a list of names.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">opendir_path</span> <span class="o">=</span> <span class="n">path</span>
                <span class="n">is_bytes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opendir_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">file_system_encoding</span><span class="p">)</span>
                <span class="n">is_bytes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">dir_p</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">opendir_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_p</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">posix_error</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">Dirent_p</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">entry</span> <span class="o">=</span> <span class="n">Dirent</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">readdir_r</span><span class="p">(</span><span class="n">dir_p</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">posix_error</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">d_name</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;..&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_bytes</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">file_system_encoding</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">PosixDirEntry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">d_type</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">d_ino</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">closedir</span><span class="p">(</span><span class="n">dir_p</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">posix_error</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_scandir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scandir_c</span> <span class="o">=</span> <span class="n">_scandir</span><span class="o">.</span><span class="n">scandir</span>

    <span class="k">if</span> <span class="n">_scandir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scandir</span> <span class="o">=</span> <span class="n">scandir_c</span>
    <span class="k">elif</span> <span class="n">ctypes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scandir</span> <span class="o">=</span> <span class="n">scandir_python</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scandir</span> <span class="o">=</span> <span class="n">scandir_generic</span>


<span class="c1"># Some other system -- no d_type or stat information</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">scandir</span> <span class="o">=</span> <span class="n">scandir_generic</span>


<span class="k">def</span> <span class="nf">_walk</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">followlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Like Python 3.5&#39;s implementation of os.walk() -- faster than</span>
<span class="sd">    the pre-Python 3.5 version as it uses scandir() internally.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nondirs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># We may not have read permission for top, in which case we can&#39;t</span>
    <span class="c1"># get a list of the files the directory contains.  os.walk</span>
    <span class="c1"># always suppressed the exception then, rather than blow up for a</span>
    <span class="c1"># minor reason when (say) a thousand readable directories are still</span>
    <span class="c1"># left to visit.  That logic is copied here.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">scandir_it</span> <span class="o">=</span> <span class="n">scandir</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">onerror</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">onerror</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">scandir_it</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">onerror</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">onerror</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_dir</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c1"># If is_dir() raises an OSError, consider that the entry is not</span>
            <span class="c1"># a directory, same behaviour than os.path.isdir().</span>
            <span class="n">is_dir</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">is_dir</span><span class="p">:</span>
            <span class="n">dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nondirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">topdown</span> <span class="ow">and</span> <span class="n">is_dir</span><span class="p">:</span>
            <span class="c1"># Bottom-up: recurse into sub-directory, but exclude symlinks to</span>
            <span class="c1"># directories if followlinks is False</span>
            <span class="k">if</span> <span class="n">followlinks</span><span class="p">:</span>
                <span class="n">walk_into</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">is_symlink</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="c1"># If is_symlink() raises an OSError, consider that the</span>
                    <span class="c1"># entry is not a symbolic link, same behaviour than</span>
                    <span class="c1"># os.path.islink().</span>
                    <span class="n">is_symlink</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">walk_into</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_symlink</span>

            <span class="k">if</span> <span class="n">walk_into</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">walk</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">topdown</span><span class="p">,</span> <span class="n">onerror</span><span class="p">,</span> <span class="n">followlinks</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">entry</span>

    <span class="c1"># Yield before recursion if going top down</span>
    <span class="k">if</span> <span class="n">topdown</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">top</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">nondirs</span>

        <span class="c1"># Recurse into sub-directories</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="c1"># Issue #23605: os.path.islink() is used instead of caching</span>
            <span class="c1"># entry.is_symlink() result during the loop on os.scandir() because</span>
            <span class="c1"># the caller can replace the directory entry during the &quot;yield&quot;</span>
            <span class="c1"># above.</span>
            <span class="k">if</span> <span class="n">followlinks</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">islink</span><span class="p">(</span><span class="n">new_path</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">walk</span><span class="p">(</span><span class="n">new_path</span><span class="p">,</span> <span class="n">topdown</span><span class="p">,</span> <span class="n">onerror</span><span class="p">,</span> <span class="n">followlinks</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">entry</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Yield after recursion if going bottom up</span>
        <span class="k">yield</span> <span class="n">top</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">nondirs</span>


<span class="k">if</span> <span class="n">IS_PY3</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
    <span class="n">walk</span> <span class="o">=</span> <span class="n">_walk</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Fix for broken unicode handling on Windows on Python 2.x, see:</span>
    <span class="c1"># https://github.com/benhoyt/scandir/issues/54</span>
    <span class="n">file_system_encoding</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()</span>

<div class="viewcode-block" id="walk"><a class="viewcode-back" href="../compat.html#effluxpy.compat.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">followlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">file_system_encoding</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="n">_walk</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">topdown</span><span class="p">,</span> <span class="n">onerror</span><span class="p">,</span> <span class="n">followlinks</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3 class="logo"><a href="../index.html">effluxpy</a></h3>
<p>The Advanced Browser and Streamer Python.</p>
<h3>Useful Links</h3>
<ul>
  <li>
    <a href="http://github.com/jkabhishek/effluxpy">effluxpy at GitHub</a>
  </li>
  <li>
    <a href="http://pypi.python.org/pypi/effluxpy">effluxpy at PyPI</a>
  </li>
  <li>
    <a href="http://github.com/jkabhishek/effluxpy/issues">Issue Tracker</a>
  </li>
</ul><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Abhishek Kumar Jaiswal.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>